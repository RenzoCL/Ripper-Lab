<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor ‚Äî Ripper</title>
    <!-- Cargar fuentes ANTES del CSS para garantizar que est√©n disponibles en m√≥vil -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/estilo.css">
    <style>
        /* Variables locales ‚Äî no dependen del CSS global para garantizar render en m√≥vil */
        :root {
            --r: #e50914;
            --r-glow: rgba(229,9,20,0.4);
        }

        .page-body {
            padding: calc(var(--header-h, 64px) + 20px) 20px 50px;
            max-width: 860px; margin: 0 auto;
            animation: fadeUp 0.4s ease both;
        }
        @keyframes fadeUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

        /* ‚îÄ‚îÄ BADGE "EN REPRODUCCI√ìN" ‚îÄ‚îÄ 
           Colores hardcodeados para que funcionen en m√≥vil
           sin depender de variables CSS */
        .label-tag {
            display: inline-flex; align-items: center; gap: 6px;
            background: #e50914;            /* rojo fijo */
            color: #ffffff;
            font-family: 'Outfit', sans-serif;
            font-size: 0.65rem; font-weight: 600;
            letter-spacing: 0.14em; text-transform: uppercase;
            padding: 5px 11px; border-radius: 4px; margin-bottom: 12px;
        }
        .label-tag::before {
            content: ''; width: 6px; height: 6px;
            background: white; border-radius: 50%;
            display: inline-block; flex-shrink: 0;
            animation: blink 1.5s infinite;
        }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.25} }

        /* ‚îÄ‚îÄ T√çTULO ‚îÄ‚îÄ
           font-family con fallback expl√≠cito */
        .title-main {
            font-family: 'Bebas Neue', 'Arial Black', sans-serif;
            font-size: clamp(1.8rem, 5vw, 3rem);
            letter-spacing: 0.04em; line-height: 1;
            background: linear-gradient(135deg, #ffffff 60%, #888888);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .meta-row  { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 18px; }
        .meta-item { font-size: 0.82rem; color: #a0a0a0; font-family: 'Outfit', sans-serif; }
        .meta-dot  { width: 3px; height: 3px; background: #444; border-radius: 50%; }
        .tono-badge {
            background: rgba(229,9,20,0.15); border: 1px solid rgba(229,9,20,0.4);
            color: #ff6060; font-size: 0.7rem; font-weight: 600;
            padding: 3px 10px; border-radius: 20px; letter-spacing: 0.08em;
        }

        /* ‚îÄ‚îÄ PLAYER WRAPPER ‚îÄ‚îÄ */
        .player-wrapper {
            border-radius: 12px; overflow: hidden;
            box-shadow:
                0 0 0 1px rgba(255,255,255,0.07),
                0 24px 60px rgba(0,0,0,0.7),
                0 0 50px rgba(229,9,20,0.06);
        }

        #video-container {
            width: 100%; aspect-ratio: 16/9;
            background: #000; position: relative;
        }

        /* Loading */
        #loading-screen {
            position: absolute; inset: 0;
            background: radial-gradient(ellipse at center, #150808 0%, #000 70%);
            z-index: 30; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 14px;
        }
        .loader-ring {
            width: 44px; height: 44px;
            border: 3px solid rgba(229,9,20,0.1); border-top-color: #e50914;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to{transform:rotate(360deg)} }
        .loader-text { font-size: 0.7rem; letter-spacing: 0.22em; text-transform: uppercase; color: #444; font-family: 'Outfit', sans-serif; }

        /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           OVERLAY YOUTUBE ‚Äî fuerza usar el bot√≥n
           Texto grande, fondo s√≥lido oscuro
        ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
        #yt-overlay {
            position: absolute; inset: 0;
            background: rgba(0, 0, 0, 0.88);
            z-index: 20; display: none;
            flex-direction: column; align-items: center; justify-content: center; gap: 14px;
            pointer-events: all; cursor: default;
        }
        .ov-icon  { font-size: 3.2rem; line-height: 1; }
        .ov-title {
            font-family: 'Bebas Neue', 'Arial Black', sans-serif;
            font-size: 1.8rem; letter-spacing: 0.1em;
            color: #ffffff; text-align: center;
        }
        .ov-sub   { font-size: 0.88rem; color: rgba(255,255,255,0.65); text-align: center; font-family: 'Outfit', sans-serif; }
        .ov-arrow {
            font-size: 2rem; color: #e50914;
            animation: bounce 0.85s ease-in-out infinite;
        }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(10px)} }

        /* Capa bloqueo total YT */
        .capa-full {
            position: absolute; inset: 0; z-index: 10; display: none;
            background: transparent; pointer-events: all; cursor: default;
        }
        /* Bloqueo solo esquina Drive */
        .capa-corner-drive {
            position: absolute; top: 0; right: 0;
            width: 110px; height: 75px; z-index: 15; display: none;
            background: transparent; pointer-events: all; cursor: not-allowed;
        }

        #player, #player iframe { width:100% !important; height:100% !important; border:none; }

        /* ‚îÄ‚îÄ PANEL CONTROLES (solo YouTube) ‚îÄ‚îÄ */
        .controls-panel {
            background: #141414; border: 1px solid rgba(255,255,255,0.07); border-top: none;
            border-radius: 0 0 12px 12px; padding: 16px 18px;
            display: none; flex-direction: column; align-items: center; gap: 14px;
        }

        .progress-track { width:100%; height:3px; background:rgba(255,255,255,0.07); border-radius:10px; overflow:hidden; }
        .progress-fill  { height:100%; width:0%; background:linear-gradient(90deg,#e50914,#ff4d4d); border-radius:10px; transition:width 0.5s linear; }

        .controls-row   { display:flex; align-items:center; gap:7px; flex-wrap:wrap; justify-content:center; }

        .btn-seek {
            background: #1c1c1c; border: 1px solid rgba(255,255,255,0.07);
            color: #a0a0a0; width:40px; height:40px; border-radius:8px;
            cursor:pointer; font-size:0.68rem; font-family:'Outfit',sans-serif; font-weight:600;
            display:flex; align-items:center; justify-content:center;
            transition:background 0.15s, color 0.15s;
        }
        .btn-seek:hover { background:rgba(255,255,255,0.09); color:white; }

        /* ‚îÄ‚îÄ BOT√ìN PLAY ‚Äî colores hardcodeados, no variables ‚îÄ‚îÄ */
        #btn-play {
            background: #e50914;            /* rojo fijo ‚Äî funciona en iOS/Android */
            border: none; color: white;
            width: 62px; height: 62px; border-radius: 50%; cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 20px rgba(229,9,20,0.4);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; position: relative;
            -webkit-appearance: none; /* reset iOS */
        }
        #btn-play:not(.playing)::after {
            content:''; position:absolute; inset:-5px; border-radius:50%;
            border:2px solid rgba(229,9,20,0.4);
            animation:pulse 1.8s ease-out infinite;
        }
        @keyframes pulse { 0%{transform:scale(1);opacity:.8} 100%{transform:scale(1.6);opacity:0} }
        #btn-play:hover  { transform:scale(1.07); box-shadow:0 8px 30px rgba(229,9,20,0.5); }
        #btn-play:active { transform:scale(0.96); }
        #btn-play svg { width:21px; height:21px; fill:white; }
        #btn-play.playing .icon-play  { display:none; }
        #btn-play.playing .icon-pause { display:block !important; }

        .sep { width:1px; height:24px; background:rgba(255,255,255,0.07); margin:0 3px; }

        .btn-restart {
            background:transparent; border:1px solid rgba(255,255,255,0.07); color:#a0a0a0;
            padding:0 12px; height:34px; border-radius:6px; cursor:pointer;
            font-family:'Outfit',sans-serif; font-size:0.68rem; font-weight:500;
            letter-spacing:0.08em; text-transform:uppercase;
            display:flex; align-items:center; gap:5px; transition:all 0.15s;
        }
        .btn-restart:hover { color:white; border-color:rgba(255,255,255,0.15); }
        .btn-restart svg   { width:12px; height:12px; }

        .drive-notice {
            display:none; margin-top:12px; padding:10px 14px;
            background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.07);
            border-radius:8px; font-size:0.78rem; color:#a0a0a0; text-align:center;
            font-family:'Outfit',sans-serif;
        }

        @media (max-width: 480px) {
            .page-body { padding-left:12px; padding-right:12px; }
            .btn-seek   { width:34px; height:34px; font-size:0.62rem; }
            #btn-play   { width:54px; height:54px; }
            .ov-title   { font-size:1.4rem; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="site-header">
        <div class="header-inner">
            <div class="col-left">
                <a href="lista-temas.html" class="btn-nav" id="btn-volver">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="12" height="12">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    <span>Volver</span>
                </a>
            </div>
            <div class="col-mid">
                <a href="home.html" class="logo">RIPPER</a>
            </div>
            <div class="col-right">
                <button id="btnLogOut" class="btn-nav btn-logout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    <span>Cerrar Sesi√≥n</span>
                </button>
            </div>
        </div>
    </header>

    <div class="page-body">

        <div style="margin-bottom:18px;">
            <!-- Badge rojo con punto parpadeante -->
            <div class="label-tag">En reproducci√≥n</div>
            <h1 class="title-main" id="txt-titulo">Cargando...</h1>
            <div class="meta-row">
                <span class="meta-item" id="txt-banda">--</span>
                <span class="meta-dot"></span>
                <span class="meta-item">Tonalidad: <span class="tono-badge" id="txt-tono">--</span></span>
            </div>
        </div>

        <div class="player-wrapper">
            <div id="video-container">
                <div id="player"></div>

                <!-- Overlay YouTube: bloquea clics, gu√≠a al bot√≥n de abajo -->
                <div id="yt-overlay">
                    <span class="ov-icon">üéµ</span>
                    <span class="ov-title">PRESIONA PLAY</span>
                    <span class="ov-sub">Usa el bot√≥n rojo de abajo para reproducir</span>
                    <span class="ov-arrow">‚ñº</span>
                </div>

                <div id="loading-screen">
                    <div class="loader-ring"></div>
                    <p class="loader-text">Obteniendo video</p>
                </div>

                <div id="capa-yt" class="capa-full"></div>
                <div id="capa-drive" class="capa-corner-drive"></div>
            </div>

            <!-- Controles ‚Äî solo para YouTube -->
            <div id="panel-controles" class="controls-panel">
                <div class="progress-track">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="controls-row">
                    <button class="btn-seek" onclick="seek(-10)">‚àí10s</button>
                    <button class="btn-seek" onclick="seek(-5)">‚àí5s</button>
                    <button class="btn-seek" onclick="seek(-1)">‚àí1s</button>

                    <button id="btn-play" onclick="togglePlay()">
                        <svg class="icon-play"  viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        <svg class="icon-pause" style="display:none" viewBox="0 0 24 24">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                        </svg>
                    </button>

                    <button class="btn-seek" onclick="seek(1)">+1s</button>
                    <button class="btn-seek" onclick="seek(5)">+5s</button>
                    <button class="btn-seek" onclick="seek(10)">+10s</button>

                    <div class="sep"></div>

                    <button class="btn-restart" onclick="reiniciar()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 .49-3.27"/>
                        </svg>
                        Reiniciar
                    </button>
                </div>
            </div>
        </div>

        <p class="drive-notice" id="aviso-drive">
            ‚ñ∂ Usa los controles del reproductor. El bot√≥n "abrir externamente" est√° deshabilitado.
        </p>

    </div>

    <script type="module">
        import { auth, db } from "./firebase.js";
        import { vigilarSesion, globalLogout } from "./js/seguridad.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        vigilarSesion(auth, db, "page-body");
        document.getElementById("btnLogOut").onclick = () => globalLogout(auth);

        const params   = new URLSearchParams(window.location.search);
        const idTema   = params.get('id');
        const catParam = params.get('cat') || 'huayno';
        document.getElementById('btn-volver').href = `lista-temas.html?cat=${catParam}`;

        window.player = null;
        let isYouTube = false;
        let playing   = false;
        let inicio    = 0;
        let temaData  = null;
        let ignorarPausa = false;

        async function init() {
            if (!idTema) return;
            try {
                const snap = await getDoc(doc(db, "temas", idTema));
                if (!snap.exists()) {
                    document.getElementById('txt-titulo').textContent = "Video no encontrado";
                    document.getElementById('loading-screen').style.display = 'none';
                    return;
                }
                temaData = snap.data();
                document.getElementById('txt-titulo').textContent = temaData.titulo    || "Sin t√≠tulo";
                document.getElementById('txt-banda').textContent  = temaData.artista   || "Artista";
                document.getElementById('txt-tono').textContent   = temaData.tonalidad || "--";
                inicio = temaData.inicio || 0;

                const s = document.createElement('script');
                s.src = "https://www.youtube.com/iframe_api";
                document.head.appendChild(s);
            } catch(e) { console.error(e); }
        }

        window.onYouTubeIframeAPIReady = function() {
            if (temaData.fuente === "youtube") {
                isYouTube = true;
                document.getElementById('panel-controles').style.display = 'flex';
                document.getElementById('capa-yt').style.display = 'block';

                window.player = new YT.Player('player', {
                    height: '100%', width: '100%',
                    videoId: temaData.videoId,
                    playerVars: {
                        start: inicio, controls: 0,
                        modestbranding: 1, rel: 0, disablekb: 1, playsinline: 1
                    },
                    events: {
                        onReady: () => {
                            document.getElementById('loading-screen').style.display = 'none';
                            document.getElementById('yt-overlay').style.display = 'flex';
                        },
                        onStateChange: ytStateChange
                    }
                });

                // Reanudar si el navegador paus√≥ al cambiar de pesta√±a
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && isYouTube && window.player && playing) {
                        ignorarPausa = true;
                        setTimeout(() => { ignorarPausa = false; }, 2000);
                        window.player.playVideo();
                    }
                });

            } else {
                // Google Drive: controles nativos libres, solo bloquear bot√≥n ext.
                document.getElementById('capa-drive').style.display = 'block';
                document.getElementById('aviso-drive').style.display = 'block';

                const iframe = document.createElement('iframe');
                iframe.src = `https://drive.google.com/file/d/${temaData.videoId}/preview`;
                iframe.allow = "autoplay";
                iframe.style.cssText = "width:100%;height:100%;border:none;";
                iframe.onload = () => document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('player').appendChild(iframe);
            }
        };

        function ytStateChange(e) {
            const btn = document.getElementById('btn-play');
            if (e.data === YT.PlayerState.PLAYING) {
                btn.classList.add('playing'); playing = true; ignorarPausa = false;
                document.getElementById('yt-overlay').style.display = 'none';
            } else if (e.data === YT.PlayerState.PAUSED) {
                btn.classList.remove('playing'); playing = false;
                if (!ignorarPausa)
                    document.getElementById('yt-overlay').style.display = 'flex';
            } else if (e.data === YT.PlayerState.ENDED) {
                btn.classList.remove('playing'); playing = false;
                document.getElementById('yt-overlay').style.display = 'flex';
            }
        }

        setInterval(() => {
            if (window.player && isYouTube && playing) {
                const d = window.player.getDuration();
                if (d > 0) document.getElementById('progress-fill').style.width =
                    (window.player.getCurrentTime() / d * 100) + '%';
            }
        }, 500);

        window.togglePlay = () => {
            if (!isYouTube || !window.player) return;
            playing ? window.player.pauseVideo() : window.player.playVideo();
        };
        window.seek = s => {
            if (isYouTube && window.player)
                window.player.seekTo(window.player.getCurrentTime() + s, true);
        };
        window.reiniciar = () => {
            if (isYouTube && window.player) {
                window.player.seekTo(inicio, true);
                window.player.playVideo();
            }
        };

        init();
    </script>
</body>
</html>
