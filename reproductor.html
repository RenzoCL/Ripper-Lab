<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor Ripper</title>
    <style>
        :root {
            --primary: #ff0000;
            --bg: #0f0f0f;
            --card: #1e1e1e;
            --text: #ffffff;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header-info { text-align: center; margin-bottom: 20px; }
        .header-info h1 { color: var(--primary); margin: 5px 0; }

        /* Contenedor del Video */
        #video-container {
            width: 100%;
            max-width: 640px;
            aspect-ratio: 16 / 9;
            background: #000;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #333;
        }

        /* CAPAS DE BLOQUEO */
        .capa-youtube {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; display: none; cursor: default;
        }
        .capa-drive-esquina {
            position: absolute; top: 0; right: 0; width: 20%; height: 20%;
            z-index: 10; display: none; background: rgba(0,0,0,0);
        }

        iframe { width: 100%; height: 100%; border: none; }

        /* PANEL DE CONTROLES */
        .controles-panel {
            background: var(--card);
            padding: 20px;
            border-radius: 0 0 12px 12px;
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .botones-row { display: flex; gap: 10px; align-items: center; }

        button {
            background: #333; border: none; color: white;
            padding: 10px 15px; border-radius: 5px; cursor: pointer;
        }

        #btn-play { background: var(--primary); font-weight: bold; width: 80px; }

        #aviso-drive { font-size: 0.8rem; color: #888; display: none; }
        
        .btn-volver { margin-bottom: 20px; align-self: flex-start; background: none; color: var(--primary); }
    </style>
</head>
<body>

    <button class="btn-volver" onclick="window.history.back()">← Volver a la lista</button>

    <div class="header-info">
        <h1 id="txt-titulo">Cargando...</h1>
        <p id="txt-banda"></p>
        <p>Tono: <span id="txt-tono"></span></p>
    </div>

    <div id="video-container">
        <div id="capa-full" class="capa-youtube"></div>
        <div id="capa-esquina" class="capa-drive-esquina"></div>
        <div id="player"></div>
    </div>

    <div id="panel-controles" class="controles-panel">
        <div class="botones-row">
            <button onclick="seek(-10)">-10s</button>
            <button onclick="seek(-5)">-5s</button>
            <button id="btn-play" onclick="togglePlay()">PLAY</button>
            <button onclick="seek(5)">+5s</button>
            <button onclick="seek(10)">+10s</button>
        </div>
        <button onclick="reiniciar()">Reiniciar canción</button>
    </div>

    <p id="aviso-drive">Usa los controles del video para reproducir y adelantar.</p>

    <script type="module">
        import { baseDeTemas } from './js/temas.js';

        const params = new URLSearchParams(window.location.search);
        const idTema = params.get('id');
        const tema = baseDeTemas[idTema];

        // Cargar API de YouTube
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.player = null;
        let isYouTube = false;
        let playing = false;
        let inicioPredeterminado = 0;

        window.onYouTubeIframeAPIReady = function() {
            if (!tema) return;

            document.getElementById('txt-titulo').innerText = tema.titulo;
            document.getElementById('txt-banda').innerText = tema.artista;
            document.getElementById('txt-tono').innerText = tema.tonalidad;
            inicioPredeterminado = tema.inicio || 0;

            if (tema.fuente === "youtube") {
                isYouTube = true;
                document.getElementById('capa-full').style.display = 'block';
                document.getElementById('panel-controles').style.display = 'flex';
                
                window.player = new YT.Player('player', {
                    height: '100%', width: '100%',
                    videoId: tema.videoId,
                    playerVars: { 'start': inicioPredeterminado, 'controls': 0, 'disablekb': 1, 'rel': 0 },
                    events: { 'onStateChange': onPlayerStateChange }
                });
            } else {
                isYouTube = false;
                document.getElementById('capa-esquina').style.display = 'block';
                document.getElementById('panel-controles').style.display = 'none';
                document.getElementById('aviso-drive').style.display = 'block';
                
                document.getElementById('player').innerHTML = `
                    <iframe src="https://drive.google.com/file/d/${tema.videoId}/preview" allow="autoplay"></iframe>
                `;
            }
        };

        function onPlayerStateChange(event) {
            const btn = document.getElementById('btn-play');
            if (event.data == YT.PlayerState.PLAYING) {
                btn.innerText = "PAUSA";
                playing = true;
            } else {
                btn.innerText = "PLAY";
                playing = false;
            }
        }

        window.togglePlay = function() {
            if (isYouTube && window.player) {
                if (playing) window.player.pauseVideo();
                else window.player.playVideo();
            }
        };

        window.seek = function(seg) {
            if (isYouTube && window.player) {
                window.player.seekTo(window.player.getCurrentTime() + seg, true);
            }
        };

        window.reiniciar = function() {
            if (isYouTube && window.player) {
                window.player.seekTo(inicioPredeterminado, true);
                window.player.playVideo();
            }
        };
    </script>
</body>
</html>