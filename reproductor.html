<!DOCTYPE html>
<html lang="es">
<head>
    </head>
<body>

    <div class="header-info">
        <h1 id="txt-titulo"></h1>
        <p id="txt-banda"></p>
        <p>Tonalidad: <b id="txt-tono"></b></p>
    </div>

    <div id="video-frame">
        <div class="capa-bloqueo"></div>
        <div id="player"></div> 
    </div>

    <div class="controles">
        <button onclick="seek(-10)">-10s</button>
        <button onclick="seek(-5)">-5s</button>
        <button id="btn-play" onclick="togglePlay()">REPRODUCIR</button>
        <button onclick="seek(5)">+5s</button>
        <button onclick="seek(10)">+10s</button>
        <button onclick="reiniciar()">REINICIAR</button>
    </div>

    <script type="module">
        import { baseDeTemas } from './js/temas.js';

        const params = new URLSearchParams(window.location.search);
        const idTema = params.get('id');
        const tema = baseDeTemas[idTema];

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.player = null;
        let isYouTube = false;
        let playing = false;
        let inicioPredeterminado = 0;

        window.onYouTubeIframeAPIReady = function() {
            if (!tema) {
                document.getElementById('txt-titulo').innerText = "Tema no encontrado";
                return;
            }

            document.getElementById('txt-titulo').innerText = tema.titulo;
            document.getElementById('txt-banda').innerText = tema.artista || "Banda Desconocida";
            document.getElementById('txt-tono').innerText = tema.tonalidad;
            inicioPredeterminado = tema.inicio || 0;

            if (tema.fuente === "youtube" && tema.videoId) {
                isYouTube = true;
                window.player = new YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: tema.videoId,
                    playerVars: { 
                        'start': inicioPredeterminado, 
                        'controls': 0, 
                        'disablekb': 1, 
                        'rel': 0,
                        'modestbranding': 1
                    },
                    events: { 'onStateChange': onPlayerStateChange }
                });
            } else if (tema.fuente === "drive" && tema.videoId) {
                isYouTube = false;
                document.getElementById('player').innerHTML = `
                    <iframe id="drive-iframe" src="https://drive.google.com/file/d/${tema.videoId}/preview" allow="autoplay"></iframe>
                `;
            }
        };

        function onPlayerStateChange(event) {
            const btn = document.getElementById('btn-play');
            if (event.data == YT.PlayerState.PLAYING) {
                btn.innerText = "PAUSAR";
                playing = true;
            } else {
                btn.innerText = "REPRODUCIR";
                playing = false;
            }
        }

        window.togglePlay = function() {
            if (isYouTube && window.player) {
                if (playing) { window.player.pauseVideo(); } 
                else { window.player.playVideo(); }
            }
        };

        window.seek = function(segundos) {
            if (isYouTube && window.player) {
                let tiempoActual = window.player.getCurrentTime();
                window.player.seekTo(tiempoActual + segundos, true);
            }
        };

        window.reiniciar = function() {
            if (isYouTube && window.player) {
                window.player.seekTo(inicioPredeterminado, true);
                window.player.playVideo();
            }
        };
    </script>
</body>
</html>