<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor Ripper Lab</title>
    <style>
        :root {
            --primary: #e63946;
            --bg: #0f0f0f;
            --card: #1a1a1a;
            --text: #ffffff;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .btn-volver {
            align-self: flex-start;
            background: none;
            border: 1px solid #333;
            color: #888;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: 0.3s;
            text-decoration: none;
            font-size: 0.9rem;
        }
        .btn-volver:hover { color: white; border-color: white; }

        .header-info { text-align: center; margin-bottom: 20px; }
        .header-info h1 { color: var(--primary); margin: 5px 0; font-size: 1.6rem; text-transform: uppercase; }
        .header-info p { margin: 2px 0; opacity: 0.8; }

        /* CONTENEDOR DE VIDEO */
        #video-container {
            width: 100%;
            max-width: 640px;
            aspect-ratio: 16 / 9;
            background: #000;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* Pantallas de Carga y Avisos */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 30; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        #aviso-play-pantalla {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 25; display: none;
            flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }

        /* Bloqueos para evitar clics externos */
        .capa-full { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: none; }
        .capa-esquina-drive { position: absolute; top: 0; right: 0; width: 80px; height: 60px; z-index: 10; display: none; }

        #player, iframe { width: 100% !important; height: 100% !important; border: none; }

        /* PANEL DE CONTROLES */
        .controles-panel {
            background: var(--card);
            padding: 20px;
            border-radius: 0 0 15px 15px;
            width: 100%;
            max-width: 600px;
            display: none; /* Se activa solo para YouTube */
            flex-direction: column;
            align-items: center;
            gap: 15px;
            border: 1px solid #222;
            box-sizing: border-box;
        }

        .botones-row { display: flex; gap: 10px; align-items: center; }

        #btn-play {
            background: var(--primary);
            color: white;
            border: none;
            width: 60px; height: 60px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-salto {
            background: #252525;
            border: 1px solid #333;
            color: white;
            width: 45px; height: 45px;
            border-radius: 50%;
            cursor: pointer;
        }

        #aviso-drive {
            margin-top: 15px; font-size: 0.85rem; color: #666; display: none;
        }
    </style>
</head>
<body>

    <a href="lista-temas.html?cat=huayno" class="btn-volver">← Volver a la lista</a>

    <div class="header-info">
        <h1 id="txt-titulo">Cargando...</h1>
        <p id="txt-banda">--</p>
        <p>Tonalidad: <b id="txt-tono">--</b></p>
    </div>

    <div id="video-container">
        <div id="player"></div>
        
        <div id="aviso-play-pantalla" onclick="togglePlay()">
            <p style="font-weight: bold; margin: 0;">PRESIONA PLAY ABAJO</p>
            <span style="font-size: 2rem; color: var(--primary);">↓</span>
        </div>

        <div id="loading-screen">
            <div class="spinner"></div>
            <p style="margin-top:10px; font-size:0.8rem;">Obteniendo video...</p>
        </div>

        <div id="capa-bloqueo-total" class="capa-full"></div>
        <div id="capa-bloqueo-drive" class="capa-esquina-drive"></div> 
    </div>

    <div id="panel-controles" class="controles-panel">
        <div class="botones-row">
            <button class="btn-salto" onclick="seek(-5)">-5s</button>
            <button class="btn-salto" onclick="seek(-10)">-10s</button>
            <button id="btn-play" onclick="togglePlay()">PLAY</button>
            <button class="btn-salto" onclick="seek(5)">+5s</button>
            <button class="btn-salto" onclick="seek(10)">+10s</button>
        </div>
        <button style="background: #222; border: 3px solid #333; color:#555; cursor:pointer; font-size:0.7rem;" onclick="reiniciar()">REINICIAR DESDE MARCA</button>
    </div>

    <p id="aviso-drive">⬆️⬆️ Usa los controles integrados para este video. ⬆️⬆️</p>

    <script type="module">
        import { db } from "./firebase.js";
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const params = new URLSearchParams(window.location.search);
        const idTema = params.get('id');

        window.player = null;
        let isYouTube = false;
        let playing = false;
        let inicioPredeterminado = 0;
        let temaData = null;

        // 1. OBTENER DATOS DE FIREBASE
        async function init() {
            if (!idTema) return;

            try {
                const docRef = doc(db, "temas", idTema);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    temaData = docSnap.data();
                    document.getElementById('txt-titulo').innerText = temaData.titulo;
                    document.getElementById('txt-banda').innerText = temaData.artista;
                    document.getElementById('txt-tono').innerText = temaData.tonalidad;
                    inicioPredeterminado = temaData.inicio || 0;

                    cargarAPI();
                } else {
                    document.getElementById('txt-titulo').innerText = "Video no encontrado";
                    document.getElementById('loading-screen').style.display = 'none';
                }
            } catch (e) {
                console.error("Error:", e);
            }
        }

        function cargarAPI() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            document.head.appendChild(tag);
        }

        // 2. CONFIGURAR REPRODUCTOR SEGÚN FUENTE
        window.onYouTubeIframeAPIReady = function() {
            const panel = document.getElementById('panel-controles');
            const aviso = document.getElementById('aviso-drive');

            if (temaData.fuente === "youtube") {
                isYouTube = true;
                panel.style.display = 'flex';
                document.getElementById('capa-bloqueo-total').style.display = 'block';

                window.player = new YT.Player('player', {
                    height: '100%', width: '100%',
                    videoId: temaData.videoId,
                    playerVars: { 
                        'start': inicioPredeterminado, 
                        'controls': 0, 'modestbranding': 1, 'rel': 0 
                    },
                    events: { 
                        'onReady': () => {
                            document.getElementById('loading-screen').style.display = 'none';
                            document.getElementById('aviso-play-pantalla').style.display = 'flex';
                        },
                        'onStateChange': onPlayerStateChange 
                    }
                });
            } else {
                // Lógica Google Drive
                aviso.style.display = 'block';
                document.getElementById('capa-bloqueo-drive').style.display = 'block';
                const iframe = document.createElement('iframe');
                iframe.src = `https://drive.google.com/file/d/${temaData.videoId}/preview`;
                iframe.onload = () => document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('player').appendChild(iframe);
            }
        };

        function onPlayerStateChange(event) {
            const btn = document.getElementById('btn-play');
            if (event.data == YT.PlayerState.PLAYING) {
                btn.innerText = "PAUSA";
                playing = true;
                document.getElementById('aviso-play-pantalla').style.display = 'none';
            } else {
                btn.innerText = "PLAY";
                playing = false;
            }
        }

        // CONTROLES PÚBLICOS
        window.togglePlay = function() {
            if (!isYouTube || !window.player) return;
            if (playing) window.player.pauseVideo();
            else window.player.playVideo();
        };

        window.seek = function(s) {
            if (isYouTube && window.player) {
                window.player.seekTo(window.player.getCurrentTime() + s, true);
            }
        };

        window.reiniciar = function() {
            if (isYouTube && window.player) {
                window.player.seekTo(inicioPredeterminado, true);
                window.player.playVideo();
            }
        };

        init();
    </script>
</body>
</html>