<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorar Temas ‚Äî Ripper</title>
    <link rel="stylesheet" href="css/estilo.css">
</head>
<body>
    <div id="lista-wrapper">

        <!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
        <header class="site-header">
            <div class="header-inner">
                <div class="col-left">
                    <a href="home.html" class="btn-nav">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="13" height="13">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        <span>Volver</span>
                    </a>
                </div>
                <div class="col-mid">
                    <a href="home.html" class="logo">RIPPER</a>
                </div>
                <div class="col-right">
                    <button id="btnLogOut" class="btn-nav btn-logout">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <span>Cerrar Sesi√≥n</span>
                    </button>
                </div>
            </div>
        </header>

        <input type="text" id="buscador" class="buscador" placeholder="üîé Buscar por t√≠tulo o artista...">

        <div class="container">
            <div id="lista" class="grid-huaynos"></div>
        </div>

    </div>

    <script type="module">
        import { auth, db } from "./firebase.js";
        import { vigilarSesion, globalLogout } from "./js/seguridad.js";
        import { collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        vigilarSesion(auth, db, "lista-wrapper");
        document.getElementById("btnLogOut").onclick = () => globalLogout(auth);

        const params    = new URLSearchParams(window.location.search);
        const catActual = params.get('cat') || 'huayno';
        const listaDiv  = document.getElementById("lista");
        const buscador  = document.getElementById("buscador");

        const normalizar = t => t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase() : "";

        const ORDEN_NOTAS = { do:1, re:2, mi:3, fa:4, sol:5, la:6, si:7 };

        let temasCache = [];

        async function cargarTemas() {
            listaDiv.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#666;padding:50px 0;">Cargando repertorio...</p>`;
            try {
                const snap = await getDocs(query(collection(db, "temas"), where("categoria", "==", catActual)));
                temasCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderFiltrado();
            } catch (e) {
                console.error(e);
                listaDiv.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#e55;padding:50px 0;">Error de conexi√≥n.</p>`;
            }
        }

        function renderFiltrado(filtro = "") {
            const txt = normalizar(filtro);

            const filtrados = temasCache
                .filter(t => normalizar(t.titulo).includes(txt) || normalizar(t.artista).includes(txt))
                .sort((a, b) => {
                    const nA = (a.tonalidad||"").toLowerCase().split(" ")[0];
                    const nB = (b.tonalidad||"").toLowerCase().split(" ")[0];
                    const mA = (a.tonalidad||"").toLowerCase().includes("menor") ? 1 : 0;
                    const mB = (b.tonalidad||"").toLowerCase().includes("menor") ? 1 : 0;
                    const diff = (ORDEN_NOTAS[nA]||99) - (ORDEN_NOTAS[nB]||99);
                    if (diff !== 0) return diff;
                    if (mA !== mB) return mA - mB;
                    return (a.titulo||"").localeCompare(b.titulo||"");
                });

            if (!filtrados.length) {
                listaDiv.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#555;padding:50px 0;">No hay temas aqu√≠.</p>`;
                return;
            }

            listaDiv.innerHTML = "";
            filtrados.forEach(t => {
                const a = document.createElement("a");
                a.href = `reproductor.html?id=${t.id}&cat=${catActual}`;
                a.className = `card tema-card ${(t.tonalidad||"").toLowerCase().trim().replace(/\s+/g,"-")}`;
                a.innerHTML = `
                    <div>
                        <span class="titulo">${t.titulo||"Sin t√≠tulo"}</span>
                        <div class="artista-sub">${t.artista||"Artista"}</div>
                    </div>
                    <span class="tono-tag">${t.tonalidad||"--"}</span>`;
                listaDiv.appendChild(a);
            });
        }

        buscador.addEventListener("input", e => renderFiltrado(e.target.value));
        cargarTemas();
    </script>
</body>
</html>
