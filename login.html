<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrar — Ripper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --red: #e50914; --red-glow: rgba(229,9,20,0.4);
            --bg:  #080808; --surface: rgba(12,12,12,0.88);
            --border: rgba(255,255,255,0.07);
            --muted: #bdbdbd;
            --font-display: 'Bebas Neue', sans-serif;
            --font-body:    'Outfit', sans-serif;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: var(--font-body); background: var(--bg); color: #fff; }

        body::after {
            content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 9999; opacity: 0.3;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
        }

        .page {
            min-height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 32px 20px;
            background-image: radial-gradient(ellipse at 20% 20%, rgba(229,9,20,0.05), transparent 50%);
        }

        .box {
            width: 100%; max-width: 380px;
            background: var(--surface); border-radius: 14px;
            padding: 30px 28px; border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
        }

        .brand {
            font-family: var(--font-display); font-size: 2.6rem;
            letter-spacing: 0.2em; color: var(--red);
            text-shadow: 0 0 28px var(--red-glow);
            display: block; margin-bottom: 4px;
        }
        .subtitle { color: var(--muted); font-size: 0.9rem; margin-bottom: 22px; }

        .error-text {
            display: none; color: #ffb3b3;
            background: rgba(255,77,77,0.08); padding: 9px 12px;
            border-radius: 7px; font-size: 0.83rem; margin-bottom: 12px;
        }

        .field       { margin-bottom: 12px; }
        .field label { display: block; font-size: 0.72rem; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; color: #ccc; margin-bottom: 6px; }
        .login-input {
            width: 100%; padding: 11px 13px; border-radius: 7px;
            border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.4);
            color: #fff; font-family: var(--font-body); font-size: 0.9rem; outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .login-input:focus { border-color: rgba(229,9,20,0.6); box-shadow: 0 0 0 3px rgba(229,9,20,0.1); }

        .btn-login {
            width: 100%; margin-top: 14px; padding: 12px;
            background: var(--red); border: none; color: white;
            border-radius: 7px; font-weight: 700; font-family: var(--font-body);
            font-size: 0.9rem; cursor: pointer; letter-spacing: 0.06em;
            transition: filter 0.2s, transform 0.1s;
        }
        .btn-login:hover  { filter: brightness(1.1); }
        .btn-login:active { transform: scale(0.98); }
        .btn-login:disabled { opacity: 0.7; cursor: not-allowed; }

        .wa-section { margin-top: 18px; text-align: center; }
        .wa-text     { color: #888; font-size: 0.82rem; margin-bottom: 10px; }
        .btn-whatsapp {
            display: inline-flex; align-items: center; gap: 7px;
            background: #25D366; color: white; padding: 9px 16px;
            border-radius: 20px; text-decoration: none; font-weight: 700; font-size: 0.85rem;
        }

        footer { margin-top: 20px; color: #555; font-size: 0.8rem; letter-spacing: 0.08em; }

        @media (max-width: 420px) {
            .box { padding: 22px 18px; }
            .brand { font-size: 2.2rem; }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="box">
            <span class="brand">RIPPER</span>
            <p class="subtitle">Partituras, audios y más</p>

            <div id="error-msg" class="error-text"></div>

            <div class="field">
                <label>Correo electrónico</label>
                <input type="email" id="email" placeholder="ejemplo@correo.com" class="login-input">
            </div>
            <div class="field">
                <label>Contraseña</label>
                <input type="password" id="password" placeholder="••••••••" class="login-input">
            </div>

            <button id="btnLogin" class="btn-login">ENTRAR</button>

            <div class="wa-section">
                <p class="wa-text">¿No tienes cuenta? Contáctame</p>
                <a href="https://wa.me/51933287274" target="_blank" class="btn-whatsapp">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </a>
            </div>
        </div>
        <footer>HECHO POR RENZO CHAVARRIA</footer>
    </div>

    <script type="module">
        import { auth, db } from "./firebase.js";
        import { signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { reclamarSesion } from "./js/seguridad.js";

        const btn = document.getElementById("btnLogin");
        const err = document.getElementById("error-msg");

        // Si ya tiene sesión activa, ir a home
        onAuthStateChanged(auth, async (user) => { 
            if (user) {
                // Antes de mandarlo a home, nos aseguramos de que este 
                // navegador sea el "dueño" actual de la sesión.
                try {
                    await reclamarSesion(db, user.uid);
                    window.location.replace("home.html");
                } catch (e) {
                    console.error("Error al reclamar sesión automática:", e);
                    // Si hay error (ej. reglas de Firestore), igual lo mandamos
                    window.location.replace("home.html");
                }
            }
        });

        async function doLogin() {
            const email = document.getElementById("email").value.trim();
            const pass  = document.getElementById("password").value;
            if (!email || !pass) return;

            btn.textContent = "VERIFICANDO...";
            btn.disabled = true;
            err.style.display = "none";

            try {
                // 1. Autenticar
                const cred = await signInWithEmailAndPassword(auth, email, pass);

                // 2. RECLAMAR SESIÓN — esto expulsa a cualquier otro dispositivo
                //    que esté usando esta cuenta en ese momento
                await reclamarSesion(db, cred.user.uid);

                // 3. Ir a home
                window.location.replace("home.html");

            } catch (e) {
                btn.textContent = "ENTRAR";
                btn.disabled = false;
                err.textContent = "Acceso denegado. Verifica tus datos.";
                err.style.display = "block";
            }
        }

        btn.onclick = doLogin;
        document.addEventListener("keydown", e => { if (e.key === "Enter") doLogin(); });
    </script>
</body>
</html>
